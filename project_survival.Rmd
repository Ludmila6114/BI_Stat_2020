---
title: "Анализ выживаемости пациентов"
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    number_section: false
date: "09/03/2021"

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Необходимые библиотеки в R:

```{r libraries, warning=TRUE, message=FALSE}
require(ggplot2)
require(survival)
require(ggfortify)
require(survminer)
require(ranger)
require(coin)
```

### Подготовка данных:

```{r}
df <- ovarian
str(df)
df$resid.ds <- factor(df$resid.ds, levels = c('1', '2'), labels = c("No", "Yes"))
df$rx <- as.factor(df$rx)
df$ecog.ps <- factor(df$ecog.ps, levels = c('1', '2'), labels = c('Good', 'Not good') )
str(df)

```

### Проведем первичный анализ данных, построим графики и распределения:

```{r}
library(ggplot2)
ggplot(data = df, aes(x = age, col = rx)) + geom_density() + theme_bw() + xlab("Возраст пациентов") + 
  ylab("Плотность распределения") +
  ggtitle('Распределение пациентов по возрасту в каждой группе лечения')
```

Видим, что в первой группе лечения распределение по возрасту более равномерное

```{r}
ggplot(data = df, aes(x = rx, y = age, fill = rx)) + 
  geom_violin() + 
  theme_bw() + 
  ggtitle("Распределение пациентов в группы лечения по возрасту\nс учетом параметра остаточной болезни: 1 - не болен, 2 - болен\nЦвет: Распределение по группам лечения") + 
  facet_wrap(.~resid.ds)+
  ylab("Возраст пациентов") +
  xlab("Группа лечения")
```

Люди с остаточной болезнью, как правило, старше, в обеих группах лечения, однако это скорее следствие возраста (приобретение болезней с возрастом)

```{r}

ggplot(data = df, aes(x = age, y = futime, col = fustat, shape = rx)) +
  geom_point(size = 5) + 
  theme_bw() + 
  facet_wrap(~ecog.ps) + 
  ggtitle("Зависимость времени выживания от возраста\nс учетом статуса цензуры (цвет), параметра ecog.ps (фасетки)\nи группы лечения(форма)")+
  xlab("Возраст пациентов")+
  ylab("Время выживания")
```

Видно, что у пациентов со статусом цензуры 1 время выживания меньше. Это можно объяснить смертью пациентов.


```{r}
ggplot(data = df, aes(x = rx, y = futime, fill = rx)) + 
  geom_violin() + 
  theme_bw() + 
  facet_wrap(.~resid.ds)+
  ylab("Время выживания") +
  xlab("Группа лечения") + 
  ggtitle("Зависимость выживания пациентов от группы лечения (цвет)\nи от остаточной болезни: 1- не болен, 2 - болен(фасетки)")
```

Отчетливо видно, что при наличии остаточной болезни, пациенты из первой группы лечения живут меньше.

### Кривые Каплана-Мейра:

Будем оценивать вероятность смерти конкретного индивидума в зависимости от времени t. 
Для начала создадим временной интервал, в рамках которого мы будет оценивать выживаемость, далее  построим линейную модель, которая учитывает изменение в выживаемости на основании фактора (группа лечения, параметр ecog.ps, возраст, например) в зависимости от времени.


1. Простая модель:


```{r}
km_fit <- survfit(Surv(futime, fustat) ~ 1, data=df)
autoplot(km_fit) + theme_bw()
```


2. Посмотрим кривую выживаемости в зависимости от типа лечения:


```{r}
km_2 <- survfit(Surv(futime, fustat) ~ rx, data=df)
autoplot(km_2) + theme_bw()
```

Кривая, соответствующая второму типу лечения, выше.

3. Посмотрим кривые в зависимости от параметра ecog.ps:


```{r}
km_3 <- survfit(Surv(futime, fustat) ~ ecog.ps, data=df)
autoplot(km_3) + theme_bw()
```

При длительном времени ожидания значение 1 (good) показывает лучшие результаты, хотя на малых временах ситуация неоднозначная.

4. Посмотрим выживаемость в зависимости от наличия остаточной болезни:


```{r}
km_4 <- survfit(Surv(futime, fustat) ~ resid.ds, data=df)
autoplot(km_4) + theme_bw()
```

Отчетливо видно, что люди, переносящие дополнительное заболевание, выживают хуже.

5. Наконец, проверим, одинаково ли выживают молодые и старые. Сначала разделим пациентов по возрасту с границей 55. 

```{r}

df$age_factor <- factor(ifelse(df$age < 55, 'Young', 'Old'))
km_5 <- survfit(Surv(futime, fustat) ~ age_factor, data=df)
autoplot(km_5) + theme_bw()
```

Видно, что молодые показывают лучшие результаты, хотя в группе молодых больше зацензурированных значений, что, вероятно, означает выздоровление, но не точно.


### Далее необходимо оценить, какие именно группы статистически различаются по выживаемости:


Будем использовать лог-ранг тесты для сравнения выживаемости между группами.

```{r}
survdiff(Surv(futime, fustat) ~ rx, data = df)
survdiff(Surv(futime, fustat) ~ ecog.ps, data = df)
survdiff(Surv(futime, fustat) ~ resid.ds, data = df)
survdiff(Surv(futime, fustat) ~ age_factor, data = df)
```
Значимые различия наблюдаются только в зависимости от возраста (p-value < 0.05, 1 df, Chisq= 4.5). Все остальные сравнения демонстрируют уровень значимости выше 0.05.


### Проведем анализ факторов, влияющих на риск с помощью отношения рисков и модели Кокса:

```{r}
fit.coxph <- coxph(Surv(futime, fustat) ~ resid.ds + ecog.ps + age_factor + rx, data = df)
ggforest(fit.coxph, data = df)


aa_fit <- aareg(Surv(futime, fustat) ~ resid.ds + ecog.ps + age_factor + rx, data = df)
autoplot(aa_fit)
```

Видим, что молодой возраст снижает риски, как и второй тип лечения, наличие остаточной болезни - повышает, но не значимо, значение параметра ecog.ps "Not good" повышает, но также не значимо.



